#!/bin/bash
# Usage:
# update-stats releases/clojars-web-current.jar /var/log/nginx/clojars.access.log.1 data/tmp/cdn-access-yesterday.log

set -e

dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

clojars_jar=$1
local_logfile=$2

cdn_logfile=/tmp/cdn-access-yesterday.log

# generate the combined cdn stats first
"$dir"/combine-cdn-logs "$clojars_jar" "$cdn_logfile"

date=$(date --date='1 day ago' +%Y%m%d)
downloads_date=/tmp/downloads-$date.edn
downloads_all_old=/tmp/all-old.edn
downloads_all_new=/tmp/all-new.edn

# grab the latest all.edn from s3
aws s3 cp "s3://${S3_STATS_BUCKET}/all.edn" "$downloads_all_old"

cat "$local_logfile" "$cdn_logfile" | java -cp "$clojars_jar" clojure.main -m clojars.tools.process-stats > "$downloads_date"
java -cp "$clojars_jar" clojure.main -m clojars.tools.merge-stats "$downloads_all_old" "$downloads_date" > "$downloads_all_new"

# upload the new stats to the s3 bucket
aws s3 cp --acl public-read "$downloads_date" "s3://${S3_STATS_BUCKET}/"
aws s3 cp --acl public-read "$downloads_all_new" "s3://${S3_STATS_BUCKET}/all.edn"
